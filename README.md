# Manga Parser (Go)

Небольшой сервис на Go для парсинга манги с h-chan (Hentai-chan), публикации страниц в Telegraph и автоматической отправки оформленного сообщения в Telegram‑канал.

## Возможности

- Парсит обе страницы одной манги:
  - `/manga/...` — забирает Название, Серия, Автор, Переводчик, Теги
  - `/online/...` — забирает ссылки на все изображения страниц
- Создаёт страницу в Telegraph c заголовком и списком изображений
- Сохраняет метаданные и служебную информацию в PostgreSQL
- Планирует и отправляет сообщение в Telegram‑канал с красивым оформлением и большим предпросмотром ссылки (ниже текста)
- Подтверждение администратором перед постингом: после парсинга бот отправляет превью поста администраторам с кнопками «Подтвердить» и «Отклонить». При подтверждении пост ставится в очередь на публикацию, при отклонении помечается как отменённый.

## Архитектура

- `parsers/` — логика парсинга. Главная точка: `HentaichanParseAll(url)`
- `cmd/processor/` — сервис‑процессор: берёт новые URL из БД, парсит, создаёт Telegraph‑страницу, планирует отправку
- `cmd/telegram-bot/` — бот‑отправитель, планировщик (`internal/scheduler`), Telegram API (`internal/telegram`)
- `database/` — модели и операции с БД (GORM)
- `telegraph/` — создание страницы в Telegraph

## Требования

- Go 1.23+
- PostgreSQL 14+

## Переменные окружения

Основные (общие):

- `POSTGRES_DSN` — строка подключения к БД, например:
  `postgres://postgres:postgres@localhost:5432/go_scripts?sslmode=disable`
- `TELEGRAM_API` — базовый URL Telegram Bot API (по умолчанию `https://api.telegram.org/bot`)
- `TELEGRAM_BOT_TOKEN` — токен Telegram‑бота
- `TELEGRAM_CHANNEL_ID` — ID канала, куда отправляем (целое число)
- `SCHEDULER_INTERVAL_SEC` — интервал проверки запланированных постов (секунды)
- `LOG_LEVEL` — уровень логирования (`INFO` по умолчанию)

Для Telegraph:

- `ACCESS_TOKEN` — токен Telegraph
- `AUTHOR_NAME` — имя автора на странице Telegraph
- `AUTHOR_URL` — ссылка автора на странице Telegraph

## Локальный запуск

1) Поднимите PostgreSQL (вариант через docker‑compose из репозитория):

```bash
docker compose up -d
```

2) Установите переменные окружения (см. выше). Удобно хранить их в `.env`.

3) Запустите процессор (парсинг + создание Telegraph + планирование):

```bash
go run cmd/processor/main.go
```

4) Отдельно запустите Telegram‑бот/планировщик (постинг в канал):

```bash
go run cmd/telegram-bot/main.go
```

## Формат сообщения в Telegram

- Заголовок: кликабельная ссылка на Telegraph
- Серия (если не "Оригинальные работы")
- Автор, Переводчик — как обычный текст
- Теги — хэштеги, в которых пробелы заменены на подчёркивания
- Большой предпросмотр ссылки находится под текстом

## Структура БД (основное)

Модель `Content` (упрощённо):

- `id` — PK
- `name` — название
- `series` — серия
- `author` — автор
- `translator` — переводчик
- `tags_json` — массив тегов в JSON
- `url_hentaichan` — исходный URL
- `url_telegraph` — ссылка на опубликованную страницу в Telegraph
- `status` — `New` | `Processing` | `Parsed` | `Confirmed` | `Cancelled` | `Sent` | `Error`
- `scheduled_at`, `sent_at`, `review_sent_at`, `last_error`, `created_at`, `updated_at`

Миграции выполняются автоматически через GORM `AutoMigrate` при старте приложения.

### Администраторы

Таблица `administrators` хранит список администраторов, которые получают превью для подтверждения:

- `id` — PK
- `telegram_user_id` — Telegram ID пользователя (уникальный)
- `username` — Никнейм (необязательно)
- `created_at`, `updated_at`

Добавляйте администраторов через БД, например:

```sql
INSERT INTO administrators (telegram_user_id, username) VALUES (123456789, 'admin');
```

## Импорт ссылок на парсинг

Создавайте записи через БД (например, `INSERT` в таблицу `contents` с `url_hentaichan` и `status='New'`) или добавьте свой входной механизм на основе имеющегося кода.

## Docker

В репозитории есть `docker-compose.yml` для PostgreSQL. При необходимости можно добавить сервисы для приложений.

## Лицензия

MIT (при необходимости измените).


